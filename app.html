<html>
    <head>
    </head>
    <body>
        <div id="login">
            <form name="login_form" action="" method="">
                Username: <input type="text"     name="username"><br/>
                Password: <input type="password" name="auth_token"><br/>
                <input type="button" value="Login" onClick="submit_login()" />
            </form>
            <a href="http://localhost:8000/api.exe?page=new_account">Create new account</a>
        </div>
        <div id="new_account">
            <form name="new_account_form" action="main.exe?submit_new_account=1" method="post">
                Username: <input type="text"     name="username"><br/>
                Password: <input type="password" name="pwd_hash"><br/>
                <input type="button" value="new_account" onClick="submit_new_account()" />
            </form>
        </div>
        <div id="app">
            <p>The App</p>
            <textarea id="text-input" oninput="this.editor.update()"
                      rows="6" cols="60">Type **Markdown** here.</textarea>
            <div id="preview"> </div>
            <!--<script>
                marked.setOptions({
                    highlight: function (code, lang) {
                        return hljs.highlightAuto(lang, code).value;
                    }
                });
                function Editor(input, preview) {
                    this.update = function () {
                        preview.innerHTML = marked(input.value);
                    };
                    input.editor = this;
                    this.update();
                }
                var $ = function (id) { return document.getElementById(id); };
                new Editor($("text-input"), $("preview"));
            </script>-->
        </div>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/7.3/highlight.min.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.3.1/jquery.cookie.min.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/marked/0.2.9/marked.min.js"></script>
        <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/sha1.js"></script>
        <script>
            apiurl = "http://localhost:8000/cgi-bin/api.exe"

            $(document).ready(function() {
                // Check if current session is valid
                $.get(apiurl, {p1: "checksession"}, function(data) {
                    console.debug(data)
                })

                //$("#new_account").hide("drop")
            })

            function submit_login() {
                frm = document.login_form

                // Get the salt for the user before doing the login
                $.get(apiurl, {p1: frm.username.value, p2: "salt"},
                      function(data) {
                          frm.auth_token.value = CryptoJS.SHA1(frm.auth_token.value + data.salt)
                          frm.auth_token.value = CryptoJS.SHA1(frm.username.value + frm.auth_token.value + $.cookie("sid"))
                          //frm.submit()
                      });                
            }

            function submit_new_account() {
                frm = document.new_account_form

                // Get the salt for the user before creating the new account
                $.get("main.exe", {api: "salt", user: frm.username.value},
                      function(data) {
                          frm.pwd_hash.value = CryptoJS.SHA1(frm.pwd_hash.value + data.salt)
                          frm.submit()
                      });                
            }
        </script>
    </body>
</html>

