<html>
    <head>
        <style>
            #div_logged_in {
                width      : 750px;
                margin     : 0 auto;
                background : #99c;
            }
            #div_header {
                padding:5px 5px;
                background:#ddd;
            }
            #div_nav {
                padding:5px 5px;
                background:#c99;
            }
            #div_footer {
                clear: both;
                background:#cc9;
                padding: 5px 5px;
            }
            #div_main {
                background:#9c9;
                float:right;
                width:530px;
                padding: 5px;
            }
            #div_sidebar {
                background:#c9c;
                float:left;
                width:200px;
                padding: 5px;
            }
            #div_nav ul {
                margin:0;
                padding:0;
                list-style:none;
            }
            #div_nav li {
                display:inline;
                margin:0;
                padding:0;
            }
        </style>
    </head>
    <body>
        <div id="div_loading">
            <p>Loading...</p>
        </div>
        <div id="div_loaded" style="display:none">
            <div id="div_not_logged_in" style="display:none">
                <form id="form_login">
                    Username: <input id="input_user" type="text"><br/>
                    Password: <input id="input_pwd"  type="password"><br/>
                    <input type="button" value="Login" onClick="submit_login()" />
                    <input type="button" value="Create New Account" onClick="submit_new_account()" />
                </form>
            </div>
            <div id="div_logged_in" style="display:none">
                <div id="div_header">
                    <p>Header</p>
                </div>
                <div id="div_nav">
                    <p>Nav</p>
                </div>
                <div id="div_sidebar">
                    <input type="button" value="New Note" onClick="new_note()" />
                    <input type="button" value="Reload Notes List" onClick="load_notes_list()" />
                    <ol id="ol_note_list">
                    </ol>
                </div>
                <div id="div_main">
                    <textarea id="textarea_note_title" rows="1" cols="60"></textarea>
                    <textarea id="textarea_note_text" rows="6" cols="60"></textarea>
                    <input type="button" value="Save" onClick="save_note()" />
                </div>
                <div id="div_footer">
                    <p>Footer</p>
                </div>
            </div>
        </div>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
        <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/sha1.js"></script>
        <script>
            apiurl = "cgi-bin/api.exe"
            sdata  = {}

            $(document).ready(function() {
                // GET the session
                $.get(apiurl, {p1: "session"}, function(data) {
                    sdata = data
                    console.log("GET session: " + JSON.stringify(sdata))

                    // Hide the "loading" div, and show the appropriate div
                    $("#div_loading").hide()
                    $("#div_loaded").show()
                    if (sdata.auth == "1") {
                        $("#div_not_logged_in").hide()
                        $("#div_logged_in").show()
                    }
                    else {
                        $("#input_user").val(sdata.user)
                        $("#div_not_logged_in").show()
                        $("#div_logged_in").hide()
                    }
                })
            })

            function submit_login() {
                u = $("#input_user").val()
                $.ajax({
                    url    : apiurl + "?p1=session&p2=" + u,
                    type   : "PUT",
                    success: function(data) {
                        console.log("PUT session: " + JSON.stringify(data))
                        console.log("user: " + u + ", salt: " + data.salt)
                        tok = CryptoJS.SHA1($("#input_pwd").val()+ data.salt)
                        console.log("pwd_hash: " + tok)
                        console.log("sid: " + data.sid)
                        tok = CryptoJS.SHA1(u + tok + data.sid)
                        $.ajax({
                            url    : apiurl + "?p1=session",
                            type   : "POST",
                            data   : {token: String(tok)},
                            success: function(data) {
                                console.log("POST session: " + JSON.stringify(data))
                                if (data.auth == 1)
                                {
                                    $("#div_not_logged_in").hide()
                                    $("#div_sidebar").show()
                                }
                            }
                        })
                    }
                })
            }

            function submit_new_account() {
                u = $("#input_user").val()
                $.ajax({
                    url    : apiurl + "?p1=session&p2=" + u,
                    type   : "PUT",
                    success: function(data) {
                        console.debug("PUT session: " + JSON.stringify(data))
                        token = CryptoJS.SHA1($("#input_pwd").val() + data.salt)
                        $.ajax({
                            url    : apiurl + "?p1=user&p2=" + u,
                            type   : "POST",
                            data   : {pwd_hash: String(token)},
                            success: function(data2) {
                                console.debug("POST session: " + JSON.stringify(data2))
                            }
                        })
                    }
                })
            }

            function save_note() {
                console.debug("Saving")
            }

            function new_note() {
                $.ajax({
                    url    : apiurl + "?p1=note",
                    type   : "POST",
                    success: function(data) {
                        console.debug("POST note: " + JSON.stringify(data))
                    }
                })
            }

            function load_notes_list() {
                $.ajax({
                    url    : apiurl + "?p1=note",
                    type   : "GET",
                    dataType: "json",
                    success: function(data) {
                        console.debug("GET note: " + JSON.stringify(data))
                        items = []
                        $.each(data.note_list, function(i, obj) {
                            items.push("<li>" + obj + "</li>")
                        })
                        $("#ol_note_list").html(items.join(""))
                    }
                })
            }

        </script>
    </body>
</html>

