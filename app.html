<html>
    <head>
    </head>
    <body>
        <div id="div_debug">
            <form id="form_debug">
                p1: <input id="input_debug_p1" type="text"><br/>
                p2: <input id="input_debug_p2" type="text"><br/>
                <input type="button" value="GET" onClick="debug_GET()" />
                <input type="button" value="PUT" onClick="debug_PUT()" />
            </form>
            <p id="debug_output">This p should display the debug output.</p>
        </div>
        <div id="div_loading">
            <p>Loading...</p>
        </div>
        <div id="div_login" style="display:none">
            <form id="form_login">
                Username: <input id="input_user" type="text"><br/>
                Password: <input id="input_pwd"  type="password"><br/>
                <input type="button" value="Login" onClick="submit_login()" />
                <input type="button" value="Create New Account" onClick="submit_new_account()" />
            </form>
        </div>
        <div id="div_app" style="display:none">
            <p>The App</p>
            <textarea id="text-input" oninput="this.editor.update()"
                      rows="6" cols="60">Type **Markdown** here.</textarea>
            <div id="preview"> </div>
            <!--<script>
                marked.setOptions({
                    highlight: function (code, lang) {
                        return hljs.highlightAuto(lang, code).value;
                    }
                });
                function Editor(input, preview) {
                    this.update = function () {
                        preview.innerHTML = marked(input.value);
                    };
                    input.editor = this;
                    this.update();
                }
                var $ = function (id) { return document.getElementById(id); };
                new Editor($("text-input"), $("preview"));
            </script>-->
        </div>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/7.3/highlight.min.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/marked/0.2.9/marked.min.js"></script>
        <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/sha1.js"></script>
        <script>
            apiurl = "cgi-bin/api.exe"
            sdata  = {}

            $(document).ready(function() {
                // GET the session
                $.get(apiurl, {p1: "session"}, function(data) {
                    sdata = data
                    console.log("GET session: " + JSON.stringify(sdata))
                })

                // Hide the "loading" div, and show the appropriate div
                $("#div_loading").hide()
                if (sdata.auth == "1") {
                    $("#div_app").show()
                }
                else {
                    $("#input_user").val(sdata.user)
                    $("#div_login").show()
                }
            })

            function submit_login() {
                u = $("#input_user").val()
                $.ajax({
                    url    : apiurl + "?p1=session&p2=" + u,
                    type   : "PUT",
                    success: function(data) {
                        console.log("PUT session: " + JSON.stringify(data))
                        console.log("user: " + u + ", salt: " + data.salt)
                        tok = CryptoJS.SHA1($("#input_pwd").val()+ data.salt)
                        console.log("pwd_hash: " + tok)
                        console.log("sid: " + data.sid)
                        tok = CryptoJS.SHA1(u + tok + data.sid)
                        $.ajax({
                            url    : apiurl + "?p1=session",
                            type   : "POST",
                            data   : {token: String(tok)},
                            success: function(data) {
                                console.log("POST session: " + JSON.stringify(data))
                                if (data.auth == 1)
                                {
                                    $("#div_app").show()
                                }
                            }
                        })
                    }
                })
            }

            function submit_new_account() {
                u = $("#input_user").val()
                $.ajax({
                    url    : apiurl + "?p1=session&p2=" + u,
                    type   : "PUT",
                    success: function(data) {
                        alert("PUT session: " + JSON.stringify(data))
                        token = CryptoJS.SHA1($("#input_pwd").val() + data.salt)
                        $.ajax({
                            url    : apiurl + "?p1=user&p2=" + u,
                            type   : "POST",
                            data   : {pwd_hash: String(token)},
                            success: function(data2) {
                                alert("POST session: " + JSON.stringify(data2))
                            }
                        })
                    }
                })
            }

            function debug_GET() {
                $.ajax({
                    url     : apiurl,
                    type    : "GET",
                    data    : {p1: $("#input_debug_p1").val()},
                    dataType: "text",
                    success : function(data) {
                        $("#debug_output").html(JSON.stringify(data))
                    }
                })
            }

            function debug_PUT() {
                $.ajax({
                    url     : apiurl + "?p1=" + $("#input_debug_p1").val() +
                                       "&p2=" + $("#input_debug_p2").val(),
                    type    : "PUT",
                    dataType: "text",
                    success : function(data) {
                        $("#debug_output").html(JSON.stringify(data))
                    }
                })
            }

        </script>
    </body>
</html>

