<html>
    <head>
    </head>
    <body>
        <div id="div_loading">
            <p>Loading...</p>
        </div>
        <div id="div_login" style="display:none">
            <form id="form_login">
                Username: <input id="input_user" type="text"><br/>
                Password: <input id="input_pwd"  type="password"><br/>
                <input type="button" value="Login" onClick="submit_login()" />
                <input type="button" value="Create New Account" onClick="submit_new_account()" />
            </form>
        </div>
        <div id="div_app" style="display:none">
            <p>The App</p>
            <textarea id="text-input" oninput="this.editor.update()"
                      rows="6" cols="60">Type **Markdown** here.</textarea>
            <div id="preview"> </div>
            <!--<script>
                marked.setOptions({
                    highlight: function (code, lang) {
                        return hljs.highlightAuto(lang, code).value;
                    }
                });
                function Editor(input, preview) {
                    this.update = function () {
                        preview.innerHTML = marked(input.value);
                    };
                    input.editor = this;
                    this.update();
                }
                var $ = function (id) { return document.getElementById(id); };
                new Editor($("text-input"), $("preview"));
            </script>-->
        </div>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/7.3/highlight.min.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.3.1/jquery.cookie.min.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/marked/0.2.9/marked.min.js"></script>
        <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/sha1.js"></script>
        <script>
            apiurl = "/cgi-bin/api.exe"
            sdata  = {}

            $(document).ready(function() {
                // GET the session
                $.get(apiurl, {p1: "session"}, function(data) {sdata = data})

                // Hide the "loading" div, and show the appropriate div
                $("#div_loading").hide()
                if (sdata.auth == "1") {
                    $("#div_app").show()
                }
                else {
                    $("#input_user").val(sdata.user)
                    $("#div_login").show()
                }
            })

            function get_user_salt(user) {
                // If the user was not registered, we need to PUT the session
                if (sdata.user == "")
                {
                    $.ajax({
                        url    : apiurl,
                        type   : "PUT",
                        data   : {p1: "session", p2: user},
                        success: function(data) {sdata.salt = data.salt}
                    })
                }
            }

            function submit_login() {
                get_user_salt($("#input_user").val())
                token = CryptoJS.SHA1($("#input_pwd").val()+ sdata.salt)
                token = CryptoJS.SHA1($("#input_user").val() + token + $.cookie("sid"))
                $.ajax({
                    url    : apiurl,
                    type   : "POST",
                    data   : {p1: "session"},
                    success: function(data) {}
                })
            }

            function submit_new_account() {
                get_user_salt($("#input_user").val())
                token = CryptoJS.SHA1($("#input_pwd").val() + sdata.salt)
                $.ajax({
                    url    : apiurl + "?p1=user",
                    type   : "POST",
                    data   : {pwd_hash: String(token)},
                    success: function(data) {}
                })
            }
        </script>
    </body>
</html>

